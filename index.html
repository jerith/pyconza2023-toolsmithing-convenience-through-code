<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="utf-8"/>
<title>Toolsmithing</title>
<meta name="author" content="Jeremy Thurgood"/>
<meta name="description" content=""/>
<meta name="keywords" content=""/>
<style type="text/css">
.underline { text-decoration: underline; }
</style>
<link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/reveal.js@4.6.0/dist/reveal.css"/>

<link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/reveal.js@4.6.0/dist/theme/night.css" id="theme"/>

<link rel="stylesheet" href="./css/extra.css"/>
<link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/reveal.js@4.6.0/plugin/highlight/zenburn.css"/></head>
<body>
<div class="reveal">
<div class="slides">
<section id="sec-title-slide">
<h1 class="title">Toolsmithing</h1>
<h3 class="subtitle">convenience through code</h3>
<br/>
<h2 class="author">Jeremy Thurgood</h2>
<br/>
<h3 class="date">PyConZA: 6 October, 2023</h2>
</section>


<section>
<section id="slide-orgbe70026">
<h2 id="orgbe70026">What is a toolsmith?</h2>
<div class="v-center-container">
<p class="heading">
A person who makes tools
</p>

<p class="fragment">
More specifically, in the context of this presentation:<br />
toolsmiths build tools to improve their own productivity,<br />
and that of their friends and colleagues.
</p>

</div></section>
<section id="slide-org56b440f">
<h3 id="org56b440f">Why build tools?</h3>
<div class="v-center-container">
<ul>
<li class="fragment">Save time</li>
<li class="fragment">Reduce complexity</li>
<li class="fragment">Existing tools don't fit</li>
<li class="fragment">It's fun</li>

</ul>

<aside class="notes">
<p>
We'll go through each of these in more detail.
</p>

</aside>

</div>

</section>
<section id="slide-org2f77c9a" data-transition="slide-in fade-out">
<h3 id="org2f77c9a">Save time</h3>
<div class="v-center-container">

<div id="org2e930eb" class="figure">
<p><img src="./img/is_it_worth_the_time_2x.png" alt="is_it_worth_the_time_2x.png" height="500px" align="center" />
</p>
<p><span class="figure-number">Figure 1: </span><a href="https://xkcd.com/1205/">https://xkcd.com/1205/</a></p>
</div>

<aside class="notes">
<p>
Automation tools can save you some time. Here's a handy chart from XKCD to help you decide if it's worth it.
</p>

</aside>

</div>

</section>
<section id="slide-orga3eca4c" data-transition="fade-in slide-out">
<h3 id="orga3eca4c">Save time?</h3>
<div class="v-center-container">

<div id="orgd157ccc" class="figure">
<p><img src="./img/automation_2x.png" alt="automation_2x.png" height="500px" align="center" />
</p>
<p><span class="figure-number">Figure 2: </span><a href="https://xkcd.com/1319/">https://xkcd.com/1319/</a></p>
</div>

<aside class="notes">
<p>
But of course, it's always more complicated.
</p>

</aside>

</div>

</section>
<section id="slide-org9e87f48">
<h3 id="org9e87f48">Reduce complexity</h3>
<div class="v-center-container">
<p class="heading">
Simple is better than complex
</p>

<ul>
<li class="fragment">Get rid of boilerplate</li>
<li class="fragment">Focus on the things you care about</li>
<li class="fragment">Remove sources of error</li>

</ul>

<aside class="notes">
<ul>
<li>Boilerplate: I want to deploy an application, not write a thousand-line k8s manifest.</li>
<li>Focus: Specify the things necessary for the app, let the robots do the rest.</li>
<li>Errors: If you only need three parameters, don't expose the other seventeen.</li>

</ul>

</aside>

</div>

</section>
<section id="slide-org94c64dc">
<h3 id="org94c64dc">Existing tools</h3>
<div class="v-center-container">
<p class="heading">
The world is full of tools
</p>

<p>
Usually you can find one to meet your needs
</p>

<p class="fragment">
Maybe you can get by with one that doesn't quite fit
</p>

<p class="fragment">
Or you can build your own
</p>

</div>

</section>
<section id="slide-org92ad2b0">
<h3 id="org92ad2b0">Fun</h3>
<div class="v-center-container">
<p class="heading">
Happy people are productive people
</p>

<p class="fragment">
We enjoy creative work, not tedious repetition
</p>

<p class="fragment">
Toolsmithing is creative work that replaces tedious repetition
</p>


</div>


</section>
</section>
<section>
<section id="slide-orgcc7c4e9">
<h2 id="orgcc7c4e9">Examples</h2>
<div class="v-center-container">
<p class="heading">
Some tools I've built recently
</p>

<ul>
<li><code>bigterm.sh</code></li>
<li><code>kustom-tool</code></li>
<li><code>filter_plan_2.py</code></li>
<li><code>clothsim.py</code></li>

</ul>

<aside class="notes">
<ul>
<li><code>bigterm.sh</code>: I promised you a tiny shell script.</li>
<li><code>kustom-tool</code>: I promised you a moderately complex cluster configuration manager.</li>
<li><code>filter_plan_2.py</code>: An ugly hack that saved us hours of downtime.</li>
<li><code>clothsim.py</code>: An art project.</li>

</ul>

</aside>


</div>


</section>
</section>
<section>
<section id="slide-orge43f061">
<h2 id="orge43f061"><code>bigterm.sh</code></h2>
<div class="v-center-container">
<p class="heading">
Makes my terminal big
</p>

</div></section>
<section id="slide-org6bf9ed9">
<h3 id="org6bf9ed9"><code>bigterm.sh</code> » problem</h3>
<div class="v-center-container">
<p class="heading">
Why do I need a tool for this?
</p>

<ul>
<li class="fragment fade-in">80x25 isn't always enough</li>
<li class="fragment fade-in">But it's a pretty good default for me</li>
<li class="fragment fade-in">Manual resizing is inconsistent</li>
<li class="fragment fade-in">Manual resizing is <i>annoying</i></li>

</ul>

</div>

</section>
<section id="slide-orgc91b321">
<h3 id="orgc91b321"><code>bigterm.sh</code> » implementation</h3>
<div class="v-center-container">
<p>
Here's the code in its entirety:
</p>

<div class="org-src-container">

<pre   ><code class="bash" data-line-numbers>#!/bin/bash

# See the CSI section at https://www.xfree86.org/current/ctlseqs.html

printf '\e[8;50;195t'  # resize to 195x50 characters
printf '\e[3;200;0t'   # move to position (200, 0) pixels
</code></pre>
</div>

<aside class="notes">
<ul>
<li>Took me about 20 minutes, 19 of which was finding and reading the relevant documentation.</li>
<li>I didn't bother making it configurable or anything.</li>

</ul>

</aside>

</div>

</section>
<section id="slide-orgdaa21f4">
<h3 id="orgdaa21f4"><code>bigterm.sh</code> » results</h3>
<div class="v-center-container">
<p class="heading">
How did it work out for me?
</p>

<ul>
<li class="fragment">I only ever notice it on computers that don't have it</li>
<li class="fragment">Six point three bazillion context switches avoided</li>
<li class="fragment">Paid for itself in happiness the first time I used it</li>

</ul>

</div>

</section>
<section id="slide-org9980118">
<h3 id="org9980118"><code>bigterm.sh</code> » lessons</h3>
<div class="v-center-container">
<p class="heading">
What can we learn from this?
</p>

<p class="fragment">
A tiny tool that solves a tiny problem can still be a big win
</p>


</div>


</section>
</section>
<section>
<section id="slide-org29509a9">
<h2 id="org29509a9"><code>kustom-tool</code></h2>
<div class="v-center-container">
<p class="heading">
Cluster configuration manager
</p>

</div></section>
<section id="slide-orgfb671df">
<h3 id="orgfb671df"><code>kustom-tool</code> » problem</h3>
<div class="v-center-container">
<p class="heading">
Why do we need a tool for this?
</p>

<ul>
<li class="fragment">Have you <i>seen</i> k8s YAML‽</li>
<li class="fragment">Deploying other people's stuff is boring
<span style="font-size:60%;">(and I don't want to do it)</span></li>
<li class="fragment">Waiting for me to deploy stuff is slow
<span style="font-size:60%;">(and they don't want to do it)</span></li>
<li class="fragment">Focus on what's important</li>

</ul>

</div>

</section>
<section id="slide-org45aec68">
<h3 id="org45aec68"><code>kustom-tool</code> » requirements</h3>
<div class="v-center-container">
<p class="heading">
What does this tool need to do?
</p>

<ul>
<li class="fragment">Static deploy manifests in the repo</li>
<li class="fragment">Minimal boilerplate</li>
<li class="fragment">Use upstream sources where practical</li>
<li class="fragment">Reasonably fast</li>

</ul>

<aside class="notes">
<ul>
<li>Static: What we see is what gets deployed, no surprises.</li>
<li>Minimal: Get rid of all the irrelevant bits.</li>
<li>Upstream: We don't want to have to reinvent existing deployments.</li>
<li>Fast: Do things in parallel.</li>

</ul>

</aside>

</div>

</section>
<section id="slide-orgd18297a">
<h3 id="orgd18297a"><code>kustom-tool</code> » approach</h3>
<div class="v-center-container">
<p class="heading">
How did we go about building it?
</p>

<ul>
<li class="fragment">Find existing tools we can use
<ul>
<li><code>kustomize</code>, <code>helm</code>, <code>ytt</code>, etc.</li>

</ul></li>
<li class="fragment">Glue those tools together</li>
<li class="fragment">Build the missing pieces</li>

</ul>

</div>

</section>
<section id="slide-orgcb1eab4">
<h3 id="orgcb1eab4"><code>kustom-tool</code> » design</h3>
<div class="v-center-container">
<p>
Two stage operation:
</p>
<ul>
<li class="fragment"><code>sources</code>: Fetch upstream sources
<ul>
<li class="fragment">k8s manifest, archive, git, helm chart, kustomize</li>
<li class="fragment">Fetches everything required to generate output</li>
<li class="fragment">Only required when sources have changed</li>

</ul></li>
<li class="fragment"><code>regenerate</code>: Build deployment manifests
<ul>
<li class="fragment">Calls <code>kustomize</code> and <code>ytt</code> to build output</li>

</ul></li>

</ul>

<aside class="notes">
<ul>
<li>manifest, archive, git: Only fetch.</li>
<li>chart, kustomize: Call external tools.</li>

</ul>

</aside>

</div>

</section>
<section id="slide-org6393820">
<h3 id="org6393820"><code>kustom-tool</code> » implementation</h3>
<div class="v-center-container">
<ul>
<li class="fragment">Python (obviously)</li>
<li class="fragment"><code>trio</code> for concurrency</li>
<li class="fragment"><code>mypy</code> and <code>ruff</code> to find most of the bugs</li>
<li class="fragment"><code>kustomize</code> plugin to call <code>ytt</code></li>
<li class="fragment">2-4 months (part time) to build</li>
<li class="fragment">It's "just worked" long enough that I forgot the rest</li>

</ul>

<aside class="notes">
<ul>
<li>trio: Because it has a sensible concurrency model</li>
<li>ruff: Best linter available</li>
<li>kustomize: plugins are horrible</li>

</ul>

</aside>

</div>

</section>
<section id="slide-org327aad5">
<h3 id="org327aad5"><code>kustom-tool</code> » results</h3>
<div class="v-center-container">
<p class="heading">
How did it work out for us?
</p>

<ul>
<li class="fragment">Deploys take minutes to prepare instead of hours/days</li>
<li class="fragment">Dev teams do 90% of the deploys themselves</li>
<li class="fragment">No YAML-related injuries since 2021</li>
<li class="fragment">External tools make setup somewhat annoying</li>

</ul>

</div>

</section>
<section id="slide-org24f0d4c">
<h3 id="org24f0d4c"><code>kustom-tool</code> » lessons</h3>
<div class="v-center-container">
<p class="heading">
What can we learn from this?
</p>

<p class="fragment">
Sometimes the tool we build is essentially a production system and should be treated as such
</p>

<p class="fragment">
Target audience matters, especially if it's more than just you
</p>

<aside class="notes">
<ul>
<li>Production: That means tests, revision control, ongoing maintenance, etc.</li>
<li>Target audience: CLI is fine. Weird setup stuff isn't ideal.</li>

</ul>

</aside>


</div>


</section>
</section>
<section>
<section id="slide-orgab9e0a7">
<h2 id="orgab9e0a7"><code>filter_plan_2.py</code></h2>
<div class="v-center-container">
<p class="heading">
Terraform plan filter
</p>

</div></section>
<section id="slide-orga401f0f">
<h3 id="orga401f0f"><code>filter_plan_2.py</code> » problem</h3>
<div class="v-center-container">
<p class="heading">
Why do we need a tool for this?
</p>

<ul>
<li class="fragment">Eight (or maybe ten?) k8s clusters to upgrade</li>
<li class="fragment">Terraform module update with <b>lots</b> of changes</li>
<li class="fragment">1k+ lines of terraform plan output</li>
<li class="fragment">100+ affected resources</li>
<li class="fragment">At least one resource that <b>must</b> be fixed</li>

</ul>

<aside class="notes">
<ul>
<li>Clusters: 4-6 hours each.</li>
<li>Module: Big refactor, they suggest recreating clusters.</li>
<li>Plan: Most of an hour to go through manually, missed things.</li>
<li>Fix: If missed, breaks the whole cluster.</li>

</ul>

</aside>

</div>

</section>
<section id="slide-org7382408">
<h3 id="org7382408"><code>filter_plan_2.py</code> » sample input</h3>
<div class="v-center-container">
<div class="org-src-container">

<pre   ><code class="text" data-line-numbers="11" data-ln-start-from="1234"># module.cluster.aws_elasticache_cluster.redis["app-redis"] will be updated in-place
~ resource "aws_elasticache_cluster" "redis" {
      id                         = "app-redis"
    ~ security_group_ids         = [
        - "sg-03fbe4e8047f95e56",
      ] -&gt; (known after apply)
      tags                       = {}
      # (21 unchanged attributes hidden)
  }

# module.cluster.module.eks.kubernetes_config_map.aws_auth[0] will be destroyed
# (because index [0] is out of range for count)
- resource "kubernetes_config_map" "aws_auth" {
    - binary_data = {} -&gt; null
    - data        = {
        - "mapAccounts" = jsonencode([])
</code></pre>
</div>

</div>

</section>
<section id="slide-org616faec">
<h3 id="org616faec"><code>filter_plan_2.py</code> » design</h3>
<div class="v-center-container">
<p class="heading">
Meh, who has time to design this
</p>

<p class="fragment">
It's just a bunch of substring matches, right?
</p>

</div>

</section>
<section id="slide-orgda3634e">
<h3 id="orgda3634e"><code>filter_plan_2.py</code> » implementation</h3>
<div class="v-center-container">
<ul>
<li class="fragment">Basically just a bunch of substring matches</li>
<li class="fragment">Grouped into sections:
<ul>
<li class="fragment">EXPECTED: Displayed for completeness</li>
<li class="fragment">UNEXPECTED: Check these to make sure they're okay</li>
<li class="fragment">WARN: Things that need manual fixing</li>

</ul></li>
<li class="fragment">200 lines of very hacky code, no tests, no repo</li>

</ul>

</div>

</section>
<section id="slide-org83f81f9">
<h3 id="org83f81f9"><code>filter_plan_2.py</code> » results</h3>
<div class="v-center-container">
<p class="heading">
How did it work out for us?
</p>

<ul>
<li class="fragment">No clusters were harmed during the upgrades</li>
<li class="fragment">(At least, not from anything related to this)</li>
<li class="fragment">Spent a couple of hours working on a better version
<ul>
<li>Configuration was messy and difficult</li>
<li>Not worth the effort, make a new one next time</li>

</ul></li>

</ul>

</div>

</section>
<section id="slide-orgcb5479d">
<h3 id="orgcb5479d"><code>filter_plan_2.py</code> » lessons</h3>
<div class="v-center-container">
<p class="heading">
What can we learn from this?
</p>

<p class="fragment">
A tool that you use once (or eight to ten times) and then throw away can still be valuable
</p>

<p class="fragment">
A hacky prototype that gets the job done may be all you need
</p>

<aside class="notes">
<ul>
<li>Production: That means tests, revision control, ongoing maintenance, etc.</li>
<li>Target audience: CLI is fine. Weird setup stuff isn't ideal.</li>

</ul>

</aside>


</div>


</section>
</section>
<section>
<section id="slide-orgf82a48c">
<h2 id="orgf82a48c"><code>clothsim.py</code></h2>
<div class="v-center-container">
<p class="heading">
Blender cloth simulation wrangler
</p>

</div></section>
<section id="slide-org12a34e3">
<h3 id="org12a34e3"><code>clothsim.py</code> » problem</h3>
<div class="v-center-container">
<p class="heading">
Why do I need a tool for this?
</p>

<ul>
<li class="fragment">I'm making a comic, which means lots of renders</li>
<li class="fragment">Every panel needs cloth simulation:
<ul>
<li class="fragment">Animate from default pose to desired pose</li>
<li class="fragment">Save simulation results as shape keys</li>
<li class="fragment">Apply shape keys and clear simulation data</li>

</ul></li>

</ul>

</div>

</section>
<section id="slide-org73d37d9" data-transition="slide-in fade-out">
<h3 id="org73d37d9"><code>clothsim.py</code> » art (unsimulated)</h3>
<div class="v-center-container">

<div id="orgb0f3edd" class="figure">
<p><img src="./img/p1p7-sketch1-nosim.png" alt="p1p7-sketch1-nosim.png" height="500px" align="center" />
</p>
<p><span class="figure-number">Figure 3: </span>Unsimulated</p>
</div>

</div>

</section>
<section id="slide-org454ecfd" data-transition="fade-in slide-out">
<h3 id="org454ecfd"><code>clothsim.py</code> » art (simulated)</h3>
<div class="v-center-container">

<div id="orgde8a2ef" class="figure">
<p><img src="./img/p1p7-sketch1.png" alt="p1p7-sketch1.png" height="500px" align="center" />
</p>
<p><span class="figure-number">Figure 4: </span>Simulated</p>
</div>

</div>

</section>
<section id="slide-org072bcf7">
<h3 id="org072bcf7"><code>clothsim.py</code> » implementation</h3>
<div class="v-center-container">
<ul>
<li class="fragment">The same as the manual process, but automated</li>
<li class="fragment">Blender's APIs are made of global mutable state
<ul>
<li class="fragment">&#x2026; because that's what 3d modelling is</li>
<li class="fragment">I still don't like it much, though</li>

</ul></li>
<li class="fragment">Very incomplete, but usable</li>

</ul>

</div>

</section>
<section id="slide-org366a7d9">
<h3 id="org366a7d9"><code>clothsim.py</code> » results</h3>
<div class="v-center-container">
<p class="heading">
How did it work out for me?
</p>

<p class="fragment">
Dunno yet, art time has been limited
</p>

<p class="fragment">
Early results are promising, though
</p>

</div>

</section>
<section id="slide-orgb4cff34">
<h3 id="orgb4cff34"><code>clothsim.py</code> » lessons</h3>
<div class="v-center-container">
<p class="heading">
What can we learn from this?
</p>

<p class="fragment">
Some tools will continue to evolve forever as requirements change
</p>

<p class="fragment">
If you try hard enough, you can find a way to show off your artwork at a tech conference <br/><img src="./img/render-server-room.jpg" alt="render-server-room.jpg" class="fragment" height="200px" align="center" style="transform: translateY(-20px);" />
</p>


</div>


</section>
</section>
<section>
<section id="slide-orgc1b9883">
<h2 id="orgc1b9883">Conclusion » summary</h2>
<div class="v-center-container">
<p class="heading">
What did we learn?
</p>

<ul>
<li><code>bigterm.sh</code> » a tiny tool can still be a big win</li>
<li><code>kustom-tool</code> » it might be a core part of your infrastructure</li>
<li><code>filter_plan_2.py</code> » value doesn't require longevity</li>
<li><code>clothsim.py</code> » it's okay to change it every time you use it</li>

</ul>

<aside class="notes">
<ul>
<li><code>bigterm.sh</code>: A tiny tool that solves a tiny problem for one person can still be a big win.</li>
<li><code>kustom-tool</code>: A core part of our infrastructure.</li>
<li><code>filter_plan_2.py</code>: Use once, throw away.</li>
<li><code>clothsim.py</code>: Ever-evolving.</li>

</ul>

</aside>

</div></section>
<section id="slide-org1a8d305">
<h3 id="org1a8d305">Conclusion » thoughts and advice</h3>
<div class="v-center-container">
<p class="heading">
So, you want to start building tools&#x2026;
</p>

<ul>
<li class="fragment">Don't be afraid to try
<ul class="fragment">
<li>You'll almost certainly learn something, at least</li>

</ul></li>
<li class="fragment">Don't be afraid to fail
<ul class="fragment">
<li>Sometimes it's not worth the effort, and that's okay</li>

</ul></li>
<li class="fragment">There's more than one way to do it
<ul class="fragment">
<li>Pick the one that fits the problem you're solving</li>

</ul></li>

</ul>

<aside class="notes">
<ul>
<li>Try: The cost of a quick hack is small.</li>
<li>Fail: Half the tools I've started building never went anywhere.</li>
<li>More than one way: My examples have all been very different. That's no accident.</li>

</ul>

</aside>


</div>


</section>
</section>
<section>
<section id="slide-org822822e">
<h2 id="org822822e">That's all, folks</h2>
<div class="v-center-container">
<p class="heading">
Questions?
</p>
</div>
</section>
</section>
</div>
</div>
<script src="https://cdn.jsdelivr.net/npm/reveal.js@4.6.0/dist/reveal.js"></script>
<script src="https://cdn.jsdelivr.net/npm/reveal.js@4.6.0/plugin/highlight/highlight.js"></script>
<script src="https://cdn.jsdelivr.net/npm/reveal.js@4.6.0/plugin/notes/notes.js"></script>


<script>
// Full list of configuration options available here:
// https://github.com/hakimel/reveal.js#configuration
Reveal.initialize({
plugins: [RevealHighlight, RevealNotes],
width: 1280, height: 720,
controlsTutorial: false,
slideNumber: "c/t",
center: false,
});

</script>
</body>
</html>
